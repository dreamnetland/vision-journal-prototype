<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vision Journal</title>

  <!-- styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- Leaflet & MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header class="card header-flex">
    <h1>Vision Journal</h1>
    <div id="header-profile" class="hidden">
      <img id="hdr-pic" src="" alt="Pic" class="hdr-pic"/>
      <span id="hdr-name" class="hdr-name"></span>
      <button id="edit-profile" class="small-btn">Edit&nbsp;Profile</button>
    </div>
  </header>

  <div class="layout">
    <main id="main-content">
      <!-- LOGIN -->
      <div id="login-screen" class="card">
        <h2>Sign Up or Log In</h2>
        <input type="email" id="email" placeholder="you@example.com" />
        <input type="password" id="password" placeholder="Password" />
        <button id="signup">Sign Up</button>
        <button id="login">Log In</button>
        <p id="login-msg"></p>
      </div>

      <!-- PROFILE ONBOARDING & EDIT -->
      <div id="profile-screen" class="card hidden">
        <h2>Your Profile</h2>
        <label>
          Display Name
          <input type="text" id="profile-name" placeholder="Jane Doe" />
        </label>
        <label>
          Profile Picture
          <input type="file" id="profile-pic" accept="image/*" />
        </label>
        <label>
          Hobbies & Interests
          <textarea id="profile-hobbies" maxlength="500" rows="3"
            placeholder="Tell us about your hobbies…"></textarea>
        </label>
        <button id="save-profile">Save Profile</button>
        <p id="profile-msg"></p>
      </div>

      <!-- MAIN JOURNAL -->
      <div id="journal-screen" class="hidden">
        <!-- INSIGHTS WITH FILTERS -->
        <div id="insights-box" class="card">
          <h2>Insights</h2>
          <div class="filters">
            <select id="filter-type">
              <option value="all">All Types</option>
              <option value="dream">Dream</option>
              <option value="nightmare">Nightmare</option>
              <option value="daydream">Daydream</option>
              <option value="insight">Insight</option>
            </select>
            <select id="filter-time">
              <option value="all">All Time</option>
              <option value="hour">Last Hour</option>
              <option value="day">Last 24 hrs</option>
              <option value="week">Last 7 days</option>
              <option value="month">Last 30 days</option>
              <option value="year">Last Year</option>
            </select>
          </div>
          <div id="map"></div>
          <p style="text-align:center;font-size:.9rem;color:#666;">
            (Zoom & pan to explore hot spots)
          </p>
        </div>

        <!-- NEW ENTRY -->
        <div id="new-entry-box" class="card">
          <h2>New Entry</h2>
          <select id="type">
            <option value="dream">Dream</option>
            <option value="nightmare">Nightmare</option>
            <option value="daydream">Daydream</option>
            <option value="insight">Insight</option>
          </select>
          <textarea id="text" placeholder="Describe..."></textarea>
          <input id="tags" placeholder="tags, comma-separated" />
          <label><input type="checkbox" id="isPublic" /> Make Public</label>
          <button id="detect-location">Detect My Country/State</button>
          <p id="location-display">(no location yet)</p>
          <div id="manual-location" class="hidden">
            <input type="text" id="country-input" placeholder="Country (required)" />
            <input type="text" id="state-input"   placeholder="State/Region (required)" />
          </div>
          <button id="save-entry">Save</button>
          <p id="entry-msg"></p>
        </div>

        <!-- MY JOURNAL LIST -->
        <div id="journal-box" class="card">
          <h2>My Journal</h2>
          <ul id="entries"></ul>
        </div>
      </div>
    </main>

    <!-- SIDEBAR FEED -->
    <aside id="feed-screen">
      <div id="logout-box" class="card hidden">
        <button id="logout">Logout</button>
      </div>
      <div class="card">
        <h2>Public Feed</h2>
        <ul id="feed-entries"></ul>
      </div>
    </aside>
  </div>

  <!-- PROFILE MODAL -->
  <div id="profile-modal" class="card hidden modal">
    <button id="close-modal" class="close-btn">×</button>
    <h2 id="modal-name"></h2>
    <img id="modal-pic" src="" class="modal-pic"/>
    <p><strong>Hobbies:</strong> <span id="modal-hobbies"></span></p>
  </div>

  <script>
    // ── Firebase Init ─────────────────────────
    const firebaseConfig = {
      apiKey: "AIzaSyD3cdFU4K-LiPtkbVcQMmNp1701dvOEFW8",
      authDomain: "vision-journal-proto.firebaseapp.com",
      projectId: "vision-journal-proto",
      storageBucket: "vision-journal-proto.appspot.com",
      messagingSenderId: "1063775796504",
      appId: "1:1063775796504:web:8effe01d8a1272afc9326d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    // ── UI REFS ───────────────────────────────
    const loginScreen   = document.getElementById('login-screen'),
          profileScreen = document.getElementById('profile-screen'),
          journalScreen = document.getElementById('journal-screen'),
          logoutBox     = document.getElementById('logout-box'),
          loginMsg      = document.getElementById('login-msg'),
          emailInput    = document.getElementById('email'),
          passwordInput = document.getElementById('password'),
          signupBtn     = document.getElementById('signup'),
          loginBtn      = document.getElementById('login'),
          logoutBtn     = document.getElementById('logout'),
          saveProfileBtn= document.getElementById('save-profile'),
          nameInput     = document.getElementById('profile-name'),
          picInput      = document.getElementById('profile-pic'),
          hobbiesInput  = document.getElementById('profile-hobbies'),
          profileMsg    = document.getElementById('profile-msg'),
          hdrProfile    = document.getElementById('header-profile'),
          hdrPic        = document.getElementById('hdr-pic'),
          hdrName       = document.getElementById('hdr-name'),
          editProfile   = document.getElementById('edit-profile'),
          filterType    = document.getElementById('filter-type'),
          filterTime    = document.getElementById('filter-time'),
          mapDiv        = document.getElementById('map'),
          detectBtn     = document.getElementById('detect-location'),
          locationDisp  = document.getElementById('location-display'),
          manualDiv     = document.getElementById('manual-location'),
          countryInput  = document.getElementById('country-input'),
          stateInput    = document.getElementById('state-input'),
          saveEntryBtn  = document.getElementById('save-entry'),
          entryMsg      = document.getElementById('entry-msg'),
          entriesList   = document.getElementById('entries'),
          feedEntries   = document.getElementById('feed-entries'),
          modal         = document.getElementById('profile-modal'),
          modalName     = document.getElementById('modal-name'),
          modalPic      = document.getElementById('modal-pic'),
          modalHobbies  = document.getElementById('modal-hobbies'),
          closeModal    = document.getElementById('close-modal');

    // ── Leaflet + Clustering ─────────────────
    let map, markers = null, leafletReady = false;
    try {
      map = L.map('map').setView([20,0],2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'&copy; OpenStreetMap'
      }).addTo(map);
      markers = L.markerClusterGroup();
      map.addLayer(markers);
      leafletReady = true;
    } catch(e){ console.warn('Leaflet init failed:',e) }

    // ── AUTH ───────────────────────────────────
    signupBtn.onclick = ()=> auth.createUserWithEmailAndPassword(
      emailInput.value, passwordInput.value
    ).catch(e=>loginMsg.textContent=e.message);

    loginBtn.onclick = ()=> auth.signInWithEmailAndPassword(
      emailInput.value, passwordInput.value
    ).catch(e=>loginMsg.textContent=e.message);

    logoutBtn.onclick = ()=> auth.signOut();

    auth.onAuthStateChanged(async user => {
      if(!user) {
        loginScreen.classList.remove('hidden');
        profileScreen.classList.add('hidden');
        journalScreen.classList.add('hidden');
        logoutBox.classList.add('hidden');
        hdrProfile.classList.add('hidden');
        return;
      }
      // check for profile doc
      const doc = await db.collection('users').doc(user.uid).get();
      if(!doc.exists) {
        loginScreen.classList.add('hidden');
        profileScreen.classList.remove('hidden');
      } else {
        const p = doc.data();
        // show header widget
        hdrPic.src = p.pic||'';
        hdrName.textContent = p.name;
        hdrProfile.classList.remove('hidden');
        // show journal
        loginScreen.classList.add('hidden');
        profileScreen.classList.add('hidden');
        journalScreen.classList.remove('hidden');
        logoutBox.classList.remove('hidden');
        if(leafletReady) setTimeout(()=>map.invalidateSize(),200);
        loadJournal();
        refreshPublic();
      }
    });

    // ── SAVE PROFILE ─────────────────────────
    saveProfileBtn.onclick = async () => {
      const user = auth.currentUser;
      const name = nameInput.value.trim();
      if(!name) {
        profileMsg.textContent = 'Name is required';
        return;
      }
      // fetch existing pic
      let picData = '';
      const ref = db.collection('users').doc(user.uid);
      const existing = await ref.get();
      if(existing.exists) picData = existing.data().pic || '';

      // new pic?
      if(picInput.files[0]) {
        picData = await new Promise(r=>{
          const fr = new FileReader();
          fr.onload = ()=>r(fr.result);
          fr.readAsDataURL(picInput.files[0]);
        });
      }

      await ref.set({
        name,
        pic: picData,
        hobbies: hobbiesInput.value.trim().split(',').map(s=>s.trim())
      });
      profileMsg.textContent = 'Saved!';
      hdrPic.src = picData;
      hdrName.textContent = name;
      // go to journal
      profileScreen.classList.add('hidden');
      journalScreen.classList.remove('hidden');
      loadJournal();
      refreshPublic();
    };

    editProfile.onclick = () => {
      // preload fields
      const user = auth.currentUser;
      db.collection('users').doc(user.uid).get().then(doc=>{
        const p = doc.data();
        nameInput.value = p.name||'';
        hobbiesInput.value = (p.hobbies||[]).join(', ');
      });
      profileScreen.classList.remove('hidden');
      journalScreen.classList.add('hidden');
    };

    // ── FILTER EVENT ─────────────────────────
    filterType.onchange = refreshPublic;
    filterTime.onchange = refreshPublic;

    // ── LOCATION DETECTION ───────────────────
    detectBtn.onclick = () => {
      locationDisp.textContent = 'Detecting…';
      fetch('https://ipapi.co/json/')
        .then(r=>r.json())
        .then(d => {
          if(d.country_name && d.region) {
            locationDisp.textContent = `${d.region}, ${d.country_name}`;
            countryInput.value = d.country_name;
            stateInput.value   = d.region;
            manualDiv.classList.add('hidden');
          } else throw '';
        })
        .catch(_ => {
          locationDisp.textContent = 'Auto-detect failed; enter manually';
          manualDiv.classList.remove('hidden');
        });
    };

    // ── SAVE ENTRY ───────────────────────────
    saveEntryBtn.onclick = async () => {
      const user    = auth.currentUser,
            country = countryInput.value.trim(),
            state   = stateInput.value.trim();
      if(!country||!state) {
        alert('Please detect or enter country & state.');
        return;
      }
      const payload = {
        userId: user.uid,
        type:   document.getElementById('type').value,
        text:   document.getElementById('text').value,
        tags:   document.getElementById('tags').value
                  .split(',').map(s=>s.trim()).filter(Boolean),
        isPublic: isPublicInput.checked,
        location: { country, state },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection('visions').doc(user.uid)
              .collection('entries').add(payload);
      if(payload.isPublic) {
        const q = encodeURIComponent(`${state}, ${country}`);
        const res = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`
        ).then(r=>r.json());
        if(res[0]) {
          payload.lat = +res[0].lat;
          payload.lon = +res[0].lon;
        }
        await db.collection('publicEntries').add(payload);
      }
      entryMsg.textContent = 'Saved!';
      loadJournal();
      refreshPublic();
    };

    // ── LOAD MY JOURNAL ──────────────────────
    function loadJournal(){
      entriesList.innerHTML = '';
      const uid = auth.currentUser.uid;
      db.collection('visions').doc(uid)
        .collection('entries').orderBy('createdAt','desc')
        .get().then(snap=>{
          snap.forEach(doc=>{
            const d = doc.data();
            const li = document.createElement('li');
            li.textContent = `${d.type}: ${d.text}`;
            entriesList.append(li);
          });
        });
    }

    // ── REFRESH PUBLIC FEED & MAP ────────────
    function computeCutoff() {
      const now = Date.now();
      switch(filterTime.value) {
        case 'hour':  return new Date(now - 3600*1000);
        case 'day':   return new Date(now - 24*3600*1000);
        case 'week':  return new Date(now - 7*24*3600*1000);
        case 'month': return new Date(now - 30*24*3600*1000);
        case 'year':  return new Date(now - 365*24*3600*1000);
        default:      return null;
      }
    }

    async function loadPublicFeed(){
      feedEntries.innerHTML = '';
      let ref = db.collection('publicEntries')
                  .orderBy('createdAt','desc');
      const cutoff = computeCutoff();
      if(cutoff) ref = ref.where('createdAt','>=',cutoff);
      if(filterType.value!=='all') {
        ref = ref.where('type','==',filterType.value);
      }
      if(!auth.currentUser) ref = ref.limit(10);

      const snap = await ref.get();
      snap.forEach(async docSnap=>{
        const d = docSnap.data();
        const udoc = await db.collection('users').doc(d.userId).get();
        const up = udoc.data()||{};
        const li = document.createElement('li');
        const btn= document.createElement('button');
        btn.textContent = up.name||'Unknown';
        btn.onclick = ()=>showProfileModal(up);
        li.append(btn, document.createTextNode(`: ${d.type}: ${d.text}`));
        feedEntries.append(li);
      });
      if(snap.empty) feedEntries.innerHTML='<p>No public entries.</p>';
    }

    async function plotPublicMarkers(){
      if(!leafletReady) return;
      markers.clearLayers();
      let ref = db.collection('publicEntries');
      const cutoff = computeCutoff();
      if(cutoff) ref = ref.where('createdAt','>=',cutoff);
      if(filterType.value!=='all') {
        ref = ref.where('type','==',filterType.value);
      }
      const snap = await ref.get();
      for(const docSnap of snap.docs){
        const d = docSnap.data();
        let {lat,lon} = d;
        if(lat==null||lon==null){
          const q = encodeURIComponent(
            `${d.location.state}, ${d.location.country}`
          );
          const res = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`
          ).then(r=>r.json());
          if(!res[0]) continue;
          lat = +res[0].lat; lon = +res[0].lon;
          await docSnap.ref.update({lat,lon});
        }
        const m = L.marker([lat,lon]).bindPopup(
          `<strong>${d.type}</strong>: ${d.text}`
        );
        markers.addLayer(m);
      }
    }

    function refreshPublic(){
      loadPublicFeed();
      if(leafletReady) plotPublicMarkers();
    }

    // ── PROFILE MODAL ────────────────────────
    function showProfileModal(up){
      modalName.textContent    = up.name;
      modalPic.src             = up.pic||'';
      modalHobbies.textContent = (up.hobbies||[]).join(', ');
      modal.classList.remove('hidden');
    }
    closeModal.onclick = ()=> modal.classList.add('hidden');
  </script>
</body>
</html>

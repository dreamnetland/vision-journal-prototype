<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vision Journal</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Firebase (compat SDK for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header><h1>Vision Journal</h1></header>

  <!-- Login Form -->
  <div id="login-screen" class="card">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="you@example.com" />
    <button id="send-link">Send Magic Link</button>
    <p id="login-msg"></p>
  </div>

  <!-- Journal Screen -->
  <div id="journal-screen" class="hidden">
    <button id="logout">Logout</button>
    <section class="card">
      <h2>New Entry</h2>
      <select id="type">
        <option value="dream">Dream</option>
        <option value="nightmare">Nightmare</option>
        <option value="daydream">Daydream</option>
        <option value="insight">Insight</option>
      </select>
      <textarea id="text" placeholder="Describe..."></textarea>
      <input id="tags" placeholder="tags, comma-separated" />
      <label><input type="checkbox" id="isPublic" /> Make Public</label>
      <button id="save-entry">Save</button>
      <p id="entry-msg"></p>
    </section>
    <section class="card">
      <h2>My Journal</h2>
      <ul id="entries"></ul>
    </section>
  </div>

  <script>
    // --- Your Firebase config here ---
    const firebaseConfig = {
      apiKey: "AIzaSyD3cdFU4K-LiPtkbVcQMmNp1701dvOEFW8",
      authDomain: "vision-journal-proto.firebaseapp.com",
      projectId: "vision-journal-proto",
      storageBucket: "vision-journal-proto.appspot.com",
      messagingSenderId: "1063775796504",
      appId: "1:1063775796504:web:8effe01d8a1272afc9326d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginScreen = document.getElementById('login-screen');
    const journalScreen = document.getElementById('journal-screen');
    const loginMsg = document.getElementById('login-msg');
    const emailInput = document.getElementById('email');
    const sendLinkBtn = document.getElementById('send-link');

    // On page load, complete sign‐in if arrived via email link
    window.addEventListener('load', () => {
      const url = window.location.href;
      if (auth.isSignInWithEmailLink(url)) {
        const storedEmail = window.localStorage.getItem('emailForSignIn');
        auth.signInWithEmailLink(storedEmail, url)
          .then(() => initJournal())
          .catch(err => {
            console.error(err);
            loginMsg.textContent = 'Error completing sign-in.';
          });
      }
    });

    // Send the magic link
    sendLinkBtn.onclick = () => {
      const email = emailInput.value;
      const actionCodeSettings = {
        url: window.location.origin + '/',   // return here after click
        handleCodeInApp: true
      };
      auth.sendSignInLinkToEmail(email, actionCodeSettings)
        .then(() => {
          window.localStorage.setItem('emailForSignIn', email);
          loginMsg.textContent = 'Magic link sent — check your email.';
        })
        .catch(err => {
          console.error(err);
          loginMsg.textContent = 'Error sending link.';
        });
    };

    // Initialize journal view
    function initJournal() {
      loginScreen.classList.add('hidden');
      journalScreen.classList.remove('hidden');
      loadEntries();
    }

    // Toggle screens based on auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        initJournal();
      } else {
        loginScreen.classList.remove('hidden');
        journalScreen.classList.add('hidden');
      }
    });

    // Save new entry
    document.getElementById('save-entry').onclick = () => {
      const type = document.getElementById('type').value;
      const text = document.getElementById('text').value;
      const tags = document.getElementById('tags').value
        .split(',').map(s => s.trim()).filter(Boolean);
      const isPublic = document.getElementById('isPublic').checked;

      db.collection('visions')
        .doc(auth.currentUser.uid)
        .collection('entries')
        .add({
          userId: auth.currentUser.uid,
          type,
          text,
          tags,
          isPublic,
          isFulfilled: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          document.getElementById('entry-msg').textContent = 'Saved!';
          loadEntries();
        })
        .catch(err => {
          console.error(err);
          document.getElementById('entry-msg').textContent = 'Save failed.';
        });
    };

    // Load and list only this user’s entries
    function loadEntries() {
      const list = document.getElementById('entries');
      list.innerHTML = '';
      db.collection('visions')
        .doc(auth.currentUser.uid)
        .collection('entries')
        .orderBy('createdAt', 'desc')
        .get()
        .then(snap => {
          snap.forEach(doc => {
            const li = document.createElement('li');
            li.textContent = `${doc.data().type}: ${doc.data().text}`;
            list.append(li);
          });
        })
        .catch(console.error);
    }

    // Logout
    document.getElementById('logout').onclick = () => auth.signOut();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vision Journal</title>

  <!-- styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- Leaflet CSS & JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>

  <script>
    // ── Firebase Init ─────────────────────────
    const firebaseConfig = {
      apiKey: "AIzaSyD3cdFU4K-LiPtkbVcQMmNp1701dvOEFW8",
      authDomain: "vision-journal-proto.firebaseapp.com",
      projectId: "vision-journal-proto",
      storageBucket: "vision-journal-proto.appspot.com",
      messagingSenderId: "1063775796504",
      appId: "1:1063775796504:web:8effe01d8a1272afc9326d"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <!-- HEADER -->
  <header class="card" style="display:flex; align-items:center; justify-content:space-between;">
    <h1 style="margin:0;">Vision Journal</h1>
    <button id="profile-button"
            style="background:none;border:none;cursor:pointer;display:flex;align-items:center;">
      <img id="profile-pic" src="default-avatar.png"
           alt="Profile"
           style="width:24px;height:24px;border-radius:50%;" />
      <span id="profile-name" style="margin-left:0.5rem;font-size:0.9rem;color:#fff;"></span>
    </button>
  </header>

  <div class="layout">
    <!-- PROFILE EDIT SCREEN -->
    <main id="profile-screen" class="card hidden" style="flex:1;">
      <h2>Your Profile</h2>
      <label>Display Name</label>
      <input type="text" id="pf-name" maxlength="50" />

      <label>Profile Picture</label>
      <input type="file" id="pf-photo" />

      <label>Hobbies & Interests (max 500 chars)</label>
      <textarea id="pf-interests" maxlength="500" placeholder="e.g. Hiking, Painting"></textarea>

      <button id="pf-save">Save Profile</button>
      <button id="pf-cancel" style="background:#aaa;margin-top:0.25rem;">Cancel</button>
      <p id="pf-msg"></p>
    </main>

    <!-- LOGIN SCREEN -->
    <main id="login-screen" class="card" style="flex:1;">
      <h2>Sign Up or Log In</h2>
      <input type="email" id="email" placeholder="you@example.com" />
      <input type="password" id="password" placeholder="Password" />
      <button id="signup">Sign Up</button>
      <button id="login">Log In</button>
      <p id="login-msg"></p>
    </main>

    <!-- JOURNAL SCREEN -->
    <main id="journal-screen" class="hidden" style="flex:1;">
      <div id="insights-box" class="card">
        <h2>Insights</h2>
        <div class="filters">
          <select id="filter-type">
            <option value="all">All Types</option>
            <option value="dream">Dream</option>
            <option value="nightmare">Nightmare</option>
            <option value="daydream">Daydream</option>
            <option value="insight">Insight</option>
          </select>
          <select id="filter-time">
            <option value="all">All Time</option>
            <option value="1h">Last Hour</option>
            <option value="24h">24 Hours</option>
            <option value="7d">7 Days</option>
            <option value="30d">30 Days</option>
          </select>
        </div>
        <div id="map"></div>
        <p style="text-align:center;font-size:.9rem;color:#666;">
          (Zoom & pan to explore hot spots)
        </p>
      </div>

      <div id="new-entry-box" class="card">
        <h2>New Entry</h2>
        <select id="type">
          <option value="dream">Dream</option>
          <option value="nightmare">Nightmare</option>
          <option value="daydream">Daydream</option>
          <option value="insight">Insight</option>
        </select>
        <textarea id="text" placeholder="Describe..."></textarea>
        <input id="tags" placeholder="tags, comma-separated" />
        <label><input type="checkbox" id="isPublic" /> Make Public</label>

        <button id="detect-location">Detect My Country/State</button>
        <p id="location-display" style="font-size:.9rem;color:#555;">
          (no location yet)
        </p>
        <div id="manual-location" class="hidden">
          <input type="text" id="country-input" placeholder="Country (required)" />
          <input type="text" id="state-input" placeholder="State/Region (required)" />
        </div>

        <button id="save-entry">Save</button>
        <p id="entry-msg"></p>
      </div>

      <div id="journal-box" class="card">
        <h2>My Journal</h2>
        <ul id="entries"></ul>
      </div>
    </main>

    <!-- SIDEBAR -->
    <aside id="feed-screen">
      <!-- Sidebar Profile Card -->
      <div id="sidebar-profile" class="card hidden" style="text-align:center;">
        <img id="sb-pic" src="default-avatar.png"
             alt="Profile"
             style="width:32px;height:32px;border-radius:50%;" />
        <div id="sb-name" style="margin-top:0.5rem;font-weight:bold;"></div>
      </div>

      <div id="logout-box" class="card hidden">
        <button id="logout">Logout</button>
      </div>

      <div class="card">
        <h2>Public Feed</h2>
        <ul id="feed-entries"></ul>
      </div>
    </aside>
  </div>

  <script>
    // ── UI & Firebase Setup ─────────────────────────
    const auth = firebase.auth(),
          db   = firebase.firestore();

    // UI refs…
    const loginScreen   = document.getElementById('login-screen'),
          journalScreen = document.getElementById('journal-screen'),
          profileScreen = document.getElementById('profile-screen'),
          logoutBox     = document.getElementById('logout-box'),
          sidebarProf   = document.getElementById('sidebar-profile'),
          loginMsg      = document.getElementById('login-msg'),
          emailInput    = document.getElementById('email'),
          passwordInput = document.getElementById('password'),
          signupBtn     = document.getElementById('signup'),
          loginBtn      = document.getElementById('login'),
          logoutBtn     = document.getElementById('logout'),
          saveBtn       = document.getElementById('save-entry'),
          detectBtn     = document.getElementById('detect-location'),
          locationDisp  = document.getElementById('location-display'),
          manualDiv     = document.getElementById('manual-location'),
          countryInput  = document.getElementById('country-input'),
          stateInput    = document.getElementById('state-input'),
          entriesList   = document.getElementById('entries'),
          feedEntries   = document.getElementById('feed-entries'),
          filterType    = document.getElementById('filter-type'),
          filterTime    = document.getElementById('filter-time'),
          profileBtn    = document.getElementById('profile-button'),
          headerPic     = document.getElementById('profile-pic'),
          headerName    = document.getElementById('profile-name'),
          sbPic         = document.getElementById('sb-pic'),
          sbName        = document.getElementById('sb-name');

    // Profile form:
    const pfName      = document.getElementById('pf-name'),
          pfPhoto     = document.getElementById('pf-photo'),
          pfInterests = document.getElementById('pf-interests'),
          pfSave      = document.getElementById('pf-save'),
          pfCancel    = document.getElementById('pf-cancel'),
          pfMsg       = document.getElementById('pf-msg');

    // ── Leaflet + Clustering ─────────────────────
    let map, markers, leafletReady = false;
    try {
      map = L.map('map').setView([20,0],2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'&copy; OpenStreetMap'
      }).addTo(map);
      markers = L.markerClusterGroup();
      map.addLayer(markers);
      leafletReady = true;
    } catch(e){
      console.warn(e);
    }

    // ── Auth Handlers ────────────────────────────
    signupBtn.onclick = () =>
      auth.createUserWithEmailAndPassword(emailInput.value,passwordInput.value)
          .catch(e=>loginMsg.textContent=e.message);

    loginBtn.onclick = () =>
      auth.signInWithEmailAndPassword(emailInput.value,passwordInput.value)
          .catch(e=>loginMsg.textContent=e.message);

    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(async user=>{
      if(user){
        // load profile…
        const profDoc = await db.collection('profiles').doc(user.uid).get();
        const d = profDoc.exists ? profDoc.data() : {};
        headerPic.src = d.photoURL || 'default-avatar.png';
        headerName.textContent = d.displayName || 'Anonymous';
        sbPic.src     = d.photoURL || 'default-avatar.png';
        sbName.textContent = d.displayName || 'Anonymous';

        loginScreen.classList.add('hidden');
        journalScreen.classList.remove('hidden');
        profileScreen.classList.add('hidden');
        logoutBox.classList.remove('hidden');
        sidebarProf.classList.remove('hidden');
        if(leafletReady) setTimeout(()=>map.invalidateSize(),200);
        loadJournal();
      } else {
        loginScreen.classList.remove('hidden');
        journalScreen.classList.add('hidden');
        profileScreen.classList.add('hidden');
        logoutBox.classList.add('hidden');
        sidebarProf.classList.add('hidden');
      }
      refreshPublic();
    });

    // ── Show Profile Form ───────────────────────
    profileBtn.onclick = ()=>{
      const uid = auth.currentUser.uid;
      db.collection('profiles').doc(uid).get().then(doc=>{
        const d = doc.exists ? doc.data() : {};
        pfName.value      = d.displayName || '';
        pfInterests.value = d.interests   || '';
      });
      loginScreen.classList.add('hidden');
      journalScreen.classList.add('hidden');
      profileScreen.classList.remove('hidden');
    };
    pfCancel.onclick = ()=>{
      profileScreen.classList.add('hidden');
      journalScreen.classList.remove('hidden');
    };

    // ── Save Profile ────────────────────────────
    pfSave.onclick = async ()=>{
      pfMsg.textContent = '';
      const uid = auth.currentUser.uid;
      const data = {
        displayName: pfName.value.trim(),
        interests:   pfInterests.value.trim()
      };
      // handle photo upload... (left as exercise)
      await db.collection('profiles').doc(uid).set(data,{merge:true});
      pfMsg.textContent = 'Profile saved!';
      setTimeout(()=>{
        profileScreen.classList.add('hidden');
        journalScreen.classList.remove('hidden');
      },800);
    };

    // ── Location Detect ─────────────────────────
    detectBtn.onclick = ()=>{
      locationDisp.textContent='Detecting…';
      fetch('https://ipapi.co/json/').then(r=>r.json()).then(d=>{
        if(d.country_name&&d.region){
          locationDisp.textContent = `${d.region}, ${d.country_name}`;
          countryInput.value = d.country_name;
          stateInput.value   = d.region;
          manualDiv.classList.add('hidden');
        } else throw '';
      }).catch(_=>{
        locationDisp.textContent='Auto–fail; enter manually';
        manualDiv.classList.remove('hidden');
      });
    };

    // ── Save Entry ──────────────────────────────
    saveBtn.onclick = async ()=>{
      const type     = document.getElementById('type').value,
            text     = document.getElementById('text').value,
            tags     = document.getElementById('tags').value
                         .split(',').map(s=>s.trim()).filter(Boolean),
            isPublic = document.getElementById('isPublic').checked,
            country  = countryInput.value.trim(),
            state    = stateInput.value.trim();
      if(!country||!state){
        alert('Please detect or enter country & state.');
        return;
      }
      let payload = {
        userId: auth.currentUser.uid,
        type,text,tags,isPublic,
        location:{country,state},
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        await db.collection('visions')
          .doc(auth.currentUser.uid)
          .collection('entries').add(payload);
        if(isPublic){
          const q = encodeURIComponent(`${state}, ${country}`);
          const res = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`
          ).then(r=>r.json());
          if(res[0]){
            payload.lat = +res[0].lat;
            payload.lon = +res[0].lon;
          }
          await db.collection('publicEntries').add(payload);
        }
        document.getElementById('entry-msg').textContent='Saved!';
        loadJournal(); refreshPublic();
      } catch(e){
        console.error(e);
        document.getElementById('entry-msg').textContent='Save failed.';
      }
    };

    // ── Load Journal ────────────────────────────
    function loadJournal(){
      entriesList.innerHTML='';
      db.collection('visions')
        .doc(auth.currentUser.uid)
        .collection('entries')
        .orderBy('createdAt','desc')
        .get().then(s=>s.forEach(doc=>{
          const d=doc.data(),
                li=document.createElement('li');
          li.textContent=`${d.type}: ${d.text}`;
          entriesList.append(li);
        }));
    }

    // ── Public + Map ────────────────────────────
    function loadPublicFeed(){
      feedEntries.innerHTML='';
      let ref = db.collection('publicEntries').orderBy('createdAt','desc');
      if(!auth.currentUser) ref=ref.limit(10);
      if(filterType.value!=='all') ref=ref.where('type','==',filterType.value);

      ref.get().then(snap=>{
        if(snap.empty){
          feedEntries.innerHTML='<p>No public entries.</p>';
          return;
        }
        const now=Date.now();
        snap.forEach(doc=>{
          const d=doc.data();
          // time filter
          if(filterTime.value!=='all'){
            const c=d.createdAt.toDate().getTime(),
                  cut={ '1h':3600000,'24h':86400000,'7d':7*86400000,'30d':30*86400000 }[filterTime.value];
            if(now-c>cut) return;
          }
          const loc=d.location||{},
                locText=loc.state?` (${loc.state},${loc.country})`:'',
                li=document.createElement('li');
          li.textContent=`${d.type}: ${d.text}${locText}`;
          feedEntries.append(li);
        });
      }).catch(e=>{
        console.error(e);
        feedEntries.innerHTML='<p>Error loading public feed.</p>';
      });
    }

    async function plotPublicMarkers(){
      if(!leafletReady) return;
      markers.clearLayers();
      const snap=await db.collection('publicEntries').get();
      const now=Date.now();
      for(let docSnap of snap.docs){
        const d=docSnap.data();
        if(filterType.value!=='all'&&d.type!==filterType.value) continue;
        if(filterTime.value!=='all'){
          const c=d.createdAt.toDate().getTime(),
                cut={ '1h':3600000,'24h':86400000,'7d':7*86400000,'30d':30*86400000 }[filterTime.value];
          if(now-c>cut) continue;
        }
        let {lat,lon}=d;
        if(lat==null||lon==null){
          const q=encodeURIComponent(`${d.location.state}, ${d.location.country}`),
                res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`)
                      .then(r=>r.json());
          if(res[0]){
            lat=+res[0].lat;
            lon=+res[0].lon;
            await docSnap.ref.update({lat,lon});
          } else continue;
        }
        const m=L.marker([lat,lon])
                  .bindPopup(`<strong>${d.type}</strong>: ${d.text}<br><em>${d.location.state}, ${d.location.country}</em>`);
        markers.addLayer(m);
      }
    }

    function refreshPublic(){
      loadPublicFeed();
      plotPublicMarkers();
    }
    filterType.onchange = refreshPublic;
    filterTime.onchange = refreshPublic;
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vision Journal</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Firebase (compat SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js for future heatmap -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="card">
    <h1>Vision Journal</h1>
  </header>

  <div class="layout">
    <!-- LEFT COLUMN -->
    <main id="main-content">
      <!-- Login Screen -->
      <div id="login-screen" class="card">
        <h2>Sign Up or Log In</h2>
        <input type="email" id="email" placeholder="you@example.com" />
        <input type="password" id="password" placeholder="Password" />
        <button id="signup">Sign Up</button>
        <button id="login">Log In</button>
        <p id="login-msg"></p>
      </div>

      <!-- Journal + Insights -->
      <div id="journal-screen" class="hidden">
        <!-- Insights -->
        <div id="insights-box" class="card">
          <h2>Insights</h2>
          <canvas id="heatmapCanvas" width="300" height="150"></canvas>
          <p style="text-align:center;font-size:0.9rem;color:#666;">
            (Interactive globe-heatmap coming soon)
          </p>
        </div>

        <!-- New Entry (with location) -->
        <div id="new-entry-box" class="card">
          <h2>New Entry</h2>
          <select id="type">
            <option value="dream">Dream</option>
            <option value="nightmare">Nightmare</option>
            <option value="daydream">Daydream</option>
            <option value="insight">Insight</option>
          </select>
          <textarea id="text" placeholder="Describe..."></textarea>
          <input id="tags" placeholder="tags, comma-separated" />
          <label>
            <input type="checkbox" id="isPublic" />
            Make Public
          </label>

          <!-- New location UI -->
          <button id="detect-location">Detect My Location</button>
          <p id="location-display" style="font-size:.9rem;color:#555;">
            No location yet.
          </p>
          <input type="hidden" id="lat" />
          <input type="hidden" id="lng" />

          <button id="save-entry">Save</button>
          <p id="entry-msg"></p>
        </div>

        <!-- My Journal -->
        <div id="journal-box" class="card">
          <h2>My Journal</h2>
          <ul id="entries"></ul>
        </div>
      </div>
    </main>

    <!-- RIGHT SIDEBAR -->
    <aside id="feed-screen">
      <div id="logout-box" class="card hidden">
        <button id="logout">Logout</button>
      </div>
      <div class="card">
        <h2>Public Feed</h2>
        <ul id="feed-entries"></ul>
      </div>
    </aside>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD3cdFU4K-LiPtkbVcQMmNp1701dvOEFW8",
      authDomain: "vision-journal-proto.firebaseapp.com",
      projectId: "vision-journal-proto",
      storageBucket: "vision-journal-proto.appspot.com",
      messagingSenderId: "1063775796504",
      appId: "1:1063775796504:web:8effe01d8a1272afc9326d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Element refs
    const loginScreen    = document.getElementById('login-screen');
    const journalScreen  = document.getElementById('journal-screen');
    const entriesList    = document.getElementById('entries');
    const feedEntries    = document.getElementById('feed-entries');
    const logoutBox      = document.getElementById('logout-box');
    const loginMsg       = document.getElementById('login-msg');
    const emailInput     = document.getElementById('email');
    const passwordInput  = document.getElementById('password');
    const signupBtn      = document.getElementById('signup');
    const loginBtn       = document.getElementById('login');
    const logoutBtn      = document.getElementById('logout');
    const saveBtn        = document.getElementById('save-entry');

    // Sign up & log in
    signupBtn.onclick = () =>
      auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
          .catch(e => loginMsg.textContent = e.message);

    loginBtn.onclick = () =>
      auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value)
          .catch(e => loginMsg.textContent = e.message);

    // Auth-state listener
    auth.onAuthStateChanged(user => {
      if (user) {
        loginScreen.classList.add('hidden');
        journalScreen.classList.remove('hidden');
        logoutBox.classList.remove('hidden');
        loadJournal();
      } else {
        loginScreen.classList.remove('hidden');
        journalScreen.classList.add('hidden');
        logoutBox.classList.add('hidden');
      }
      loadPublicFeed();
    });

    // Logout
    logoutBtn.onclick = () => auth.signOut();

    // Geolocation: fill lat/lng when clicked
    document.getElementById('detect-location').onclick = () => {
      const display = document.getElementById('location-display');
      if (!navigator.geolocation) {
        display.textContent = 'Geolocation not supported.';
        return;
      }
      display.textContent = 'Locatingâ€¦';
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          document.getElementById('lat').value = latitude;
          document.getElementById('lng').value = longitude;
          display.textContent = `Lat: ${latitude.toFixed(5)}, Lng: ${longitude.toFixed(5)}`;
        },
        err => {
          console.error(err);
          display.textContent = 'Location failed: ' + err.message;
        }
      );
    };

    // Save new entry (with location)
    saveBtn.onclick = () => {
      const type     = document.getElementById('type').value;
      const text     = document.getElementById('text').value;
      const tags     = document.getElementById('tags').value
                        .split(',').map(s=>s.trim()).filter(Boolean);
      const isPublic = document.getElementById('isPublic').checked;
      const lat      = parseFloat(document.getElementById('lat').value) || null;
      const lng      = parseFloat(document.getElementById('lng').value) || null;

      db.collection('visions').doc(auth.currentUser.uid)
        .collection('entries').add({
          userId: auth.currentUser.uid,
          type, text, tags, isPublic,
          location: { lat, lng },
          isFulfilled: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          document.getElementById('entry-msg').textContent = 'Saved!';
          loadJournal();
        })
        .catch(() => {
          document.getElementById('entry-msg').textContent = 'Save failed.';
        });
    };

    // Load personal journal
    function loadJournal() {
      entriesList.innerHTML = '';
      db.collection('visions').doc(auth.currentUser.uid)
        .collection('entries').orderBy('createdAt','desc').get()
        .then(snap => {
          snap.forEach(d => {
            const li = document.createElement('li');
            li.textContent = `${d.data().type}: ${d.data().text}`;
            entriesList.append(li);
          });
        });
    }

    // Load public feed
    function loadPublicFeed() {
      feedEntries.innerHTML = '';
      let q = db.collectionGroup('entries')
                .where('isPublic','==',true)
                .orderBy('createdAt','desc');
      if (!auth.currentUser) q = q.limit(10);
      q.get().then(snap => {
        snap.forEach(d => {
          const e = d.data();
          const li = document.createElement('li');
          li.textContent = `${e.type}: ${e.text}`;
          feedEntries.append(li);
        });
        if (!feedEntries.children.length)
          feedEntries.innerHTML = '<p>No public entries.</p>';
      });
    }

    // Placeholder Chart setup
    const ctx = document.getElementById('heatmapCanvas').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['dream','nightmare','daydream','insight'],
        datasets: [{ label: 'Count', data: [0,0,0,0] }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  </script>
</body>
</html>
